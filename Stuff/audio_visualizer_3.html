<!DOCTYPE html>
<html>
<head>
	<title>Audio Visualizer 3.0</title>
	<link rel="icon" 
      type="image/x-icon" 
	  href="https://drawesome4333.github.io/favicon.ico">
	  <style>
	  .playlistItem{
		cursor:pointer;
		border:1pt black solid;
		transition:all 0.25s ease-in-out;
	  }
	  .playlistItem:hover{
		  background-color:rgb(240,240,240);
	  }
	  .playing{
		  background-color:rgb(141, 141, 248);
	  }
	  .error{
		  background-color:rgb(240,150,150);
	  }
	  #Playlist{
		  width:25vw;
		  height:50vh;
		  overflow:scroll;
	  }
	  </style>
</head>
<body>
<audio id="audio" controls>
 <source id="src" type="audio/mp3">
 HTML5 Audio element is not supported on your browser.
</audio>
<br>
<input type="button" value="Start Listening" onclick="start();requestMic();">
<br>
<p onclick="var eve=new MouseEvent('click');start();fEle.dispatchEvent(eve);">Load a file</p>

<input type="file" id="files" accept="audio/*;" multiple style="display:none;">
<p id="op"></p>
<canvas id="can" width = 1000 height = 300></canvas>
<div id = "Playlist"></div>
<script>
var aSrc=document.getElementById("src");
var aEle=document.getElementById("audio");
var fEle=document.getElementById("files");
var pEle = document.getElementById("Playlist");
var op=document.getElementById("op");
var hasStarted = false;
var audioCtx;
var source;
var mSource;
var ct = document.getElementById("can").getContext("2d");
var analyser;
var gainNode;
var arr;
var dataArray;

var Graphics = {
	canvas:document.createElement("CANVAS"),
	gl:null,
	canvas_settings:{
		width:0,
		height:0,
		top:0,
		left:0,
		p_width:0,
		p_height:0,//previous width/height, lets a function know if the view port needs to be updated
		fullScreen:false,//if true the canvas will attempt to take up the whole screen
		shouldShow:true
	},
	particles:{
		
	},
	cubes:{

	},
	state:{
		mode:-1,//-2 is fatal error(IE no WebGL or Audioapi),-1 is not running, 0 is frequencyParticles, 1 is cubeField, 2 is cubeWaveForm
		particles:true//wether or not to do particles on modes that don't require it
	}

}
function Song(fileElement,fileNumber){
	this.length = 0;
	this.title = "Unknown";
	this.fileName = fileElement.files[fileNumber].name;
	this.artist = "Unkown Artist";
	this.album = "Unkown Album";
	this.composer = "";
	this.cover = null;//cover image file if one exists
	this.flagged = false;//if true this song has an error that wont allow it to play
	this.format = "";
	this.fileElement = fileElement;//describes which file element holds this song's files
	this.fileNumber = fileNumber;
	this.URL = URL.createObjectURL(fileElement.files[fileNumber]);//used to store the URL created to pass song as a source to the audio player
	this.active = true;//so user can deactivate a song
	this.playlistItem = document.createElement("div");
	this.playlistItem.innerHTML=this.fileName;
	this.playlistItem.classList.add("playlistItem");
	//this.playlistItem.style.cursor = "grab";
	this.playlistItem.addEventListener("click",function(){
		var songId = this.id.substring(5,10);
		var songNumber = parseInt(songId,10);
		aSrc.src = Player.songs[songNumber].URL;
		aEle.load();
		aEle.play()
	});
	var idString = (Player.songs.length).toString();
	while(idString.length<5){
		idString = "0"+idString;
	}
	this.playlistItem.id="song"+idString;
	var checkBox = document.createElement("input");
	checkBox.type="checkbox";
	checkBox.style.cursor="pointer";
	checkBox.checked=true;
	this.playlistItem.appendChild(checkBox);
	pEle.appendChild(this.playlistItem);
}

var Audio = {
	ctx:null,
	gainNode:null,
	state:{
		volume:0,
		source:-1,//-1 for none, 0 for music, 1 for microphone
	},
	microphone:{
		source:null,//the aduio context source
		playing:false//tells if the microphone is active or not
	},
	music:{
		source:null//the html element that will play the music is linked here
		//playing is not needed as this will not be controlled by the audio object but the player object
	}

}

var Player = {
	songs:[],
	songId:-1,
	paused:true,
	playing:false,
	shuffle:false,
	repeat:0,//0 for no repats, 1 for repeat playlist, 2 for repeat song
	controls:{//List of HTML elements for the controls on screen
		controlContainer:null,
		playButton:null,//play and pause
		timeLine:null,
		timeBack:null,
		timeDot:null,
		fastforwardButton:null,
		rewindButton:null,
		backButton:null,
		skipButton:null,
		volumeDot:null,
		volumeLine:null,
		volumeBack:null,
		repeatButton:null
	},
	resources:{//List of images
		pause:null,
		play:null,
		repeatAll:null,
		repeatOne:null,
		repeatNone:null,
		fastforward:null,
		skip:null,
		back:null,
		rewind:null,
		dot:null,
		pauseDisabled:null,
		playDisabled:null,
		skipDisabled:null,
		backDisabled:null,
		rewindDisabled:null
	},
	loadSongs:function(fileList){
		var fLength= fileList.length
		for(var sc = 0;sc<fLength;sc++){
			var newSong = new Song(fEle,sc);
			Player.songs.push(newSong);
		}
	}

}

var fileElements=[];//a list of file elements that can hold the music files
function start(){
	if (hasStarted)
		return;
	hasStarted = true;
	audioCtx= new (window.AudioContext || window.webkitAudioContext)();
	source=audioCtx.createMediaElementSource(aEle);
	analyser=audioCtx.createAnalyser();
	gainNode = audioCtx.createGain();
	source.connect(analyser);
	analyser.connect(gainNode);
	gainNode.connect(audioCtx.destination);
	gainNode.gain.setValueAtTime(0, audioCtx.currentTime);//Mute audio so it doesn't create feedback
	analyser.fftSize=2048;
	fEle.addEventListener("change",function(){aSrc.src=URL.createObjectURL(fEle.files[0]);aEle.load();aEle.play();gainNode.gain.setValueAtTime(1,audioCtx.currentTime);if(mSource){mSource.disconnect(analyser)}
	Player.loadSongs(fEle.files);
	})
	//fEle.addEventListener("change",function(){aSrc.src=URL.createObjectURL(fEle.files[0]);aEle.load();aEle.play();gainNode.gain.setValueAtTime(1,audioCtx.currentTime);if(mSource){mSource.disconnect(analyser)}})
	arr=new Uint8Array(analyser.frequencyBinCount);
	dataArray = new Uint8Array(analyser.frequencyBinCount);
	update();
};
function requestMic(){
	if (navigator.mediaDevices.getUserMedia) {
  		navigator.mediaDevices.getUserMedia({audio: true, video: false}).then( function(stream) {
    	mSource = audioCtx.createMediaStreamSource(stream);
		mSource.connect(analyser);
		console.log(stream)
  }).catch(errorCallback);
} else {
  alert("***Could not obtain Microphone access***\nClick 'Load a File' to upload an audio file instead")
}
}
function update(){
	requestAnimationFrame(update);
	analyser.getByteFrequencyData(arr);
									//op.innerHTML=Math.max.apply(null,arr);

  analyser.getByteTimeDomainData(dataArray);
	
	ct.clearRect(0,0,1000,300);
	ct.strokeStyle="black";
	ct.fillStyle="Green";
	ct.beginPath();
	ct.moveTo(0,-arr[0]+200);
	for(var i = 1;i<arr.length;i++){
		ct.lineTo(1000/arr.length*i,-arr[i]+300);
	}
	ct.lineTo(1000,300);
	ct.lineTo(0,300);
	ct.fill();
	ct.stroke();

	ct.beginPath();
	ct.moveTo(0,-dataArray[0]+200);
	for(var i = 1;i<dataArray.length;i++){
		ct.lineTo(1000/dataArray.length*i,-dataArray[i]+300);
	}
	ct.lineTo(1000,300);
	ct.lineTo(0,300);
ct.strokeStyle="rgba(255,0,0,128)"
					
ct.stroke();

	
}
var errorCallback = function(e) {
	alert("***Could not obtain Microphone access***\nClick 'Load a File' to upload an audio file instead")
    console.log(e);
  };
</script>

</body>
</html>
